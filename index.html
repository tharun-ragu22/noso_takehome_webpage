<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Analysis Transcript</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Custom style for the clickable highlights */
        .highlight-span {
            /* Background color for the highlight - a subtle yellow */
            background-color: #fce38a;
            /* Underline to denote interactivity, similar to web links */
            text-decoration: underline;
            text-decoration-color: #f3d04e;
            text-decoration-thickness: 2px;
            text-underline-offset: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
            padding: 2px 4px; /* Add slight padding around highlighted text */
            margin: -2px 0; /* Adjust margin to prevent layout shift */
            display: inline; /* Keep it inline */
        }
        .highlight-span:hover {
            background-color: #f8c32d;
        }
        /* Styles for specific speaker roles */
        .speaker-Customer {
            color: #1e3a8a; /* Dark blue */
            font-weight: 600;
        }
        .speaker-Technician {
            color: #059669; /* Emerald green */
            font-weight: 600;
        }
        /* Style for the container of the transcript lines */
        .transcript-line {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-left: 4px solid #e5e7eb;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        /* Fix for mobile/small screen sidebar positioning */
        @media (max-width: 768px) {
            #annotation-sidebar {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                transform: translateY(100%);
                transition: transform 0.3s ease-in-out;
                z-index: 50; /* Ensure it's above other content */
                height: auto; /* Allow content to dictate height */
                max-height: 80vh; /* Limit max height */
                overflow-y: auto;
            }
            #annotation-sidebar.active {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Customer Service Call Analysis</h1>
        <p class="text-gray-500">Analysis objectives: Introduction, Diagnosis, Solution, Upsell, Maintenance, Closing, Call Type, Sales Insights.</p>
    </header>

    <div class="md:grid md:grid-cols-3 gap-8">
        
        <!-- Transcript Column (2/3 width on desktop) -->
        <div id="transcript-container" class="md:col-span-2 mb-8 md:mb-0">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Call Transcript</h2>
            <!-- Dynamic transcript will be inserted here -->
            <div id="transcript-content">
                <p class="text-gray-500 italic p-4 bg-white rounded-lg">Loading transcript...</p>
            </div>
        </div>

        <!-- Annotation Sidebar (1/3 width on desktop) -->
        <div id="sidebar-container" class="md:col-span-1">
            <div id="annotation-sidebar" class="bg-white p-6 rounded-lg shadow-xl border border-gray-200 h-full md:sticky md:top-8 md:h-[calc(100vh-4rem)]">
                
                <div id="default-message" class="text-center py-10 text-gray-500 transition-opacity duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V9a2 2 0 012-2h10a2 2 0 012 2v2m-2 4h4a2 2 0 002-2v-2h-4v2h-2v2z" />
                    </svg>
                    <p>Click on a highlighted phrase to see which call objective it meets or defies.</p>
                </div>

                <div id="annotation-content" class="hidden">
                    <button id="close-btn" class="md:hidden absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <p class="text-sm font-semibold mb-1 text-gray-400 uppercase tracking-wider">Analysis Area</p>
                    <p id="annotation-type" class="text-xl font-bold mb-4 text-gray-800"></p>
                    
                    <hr class="mb-4">
                    
                    <p class="text-sm font-semibold mb-2 text-gray-400 uppercase tracking-wider">Insight</p>
                    <p id="annotation-note" class="text-gray-700 leading-relaxed"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- The external JSON file 'transcript_data.json' is now loaded using fetch() in the script below. -->

    <script>
            // --- DATA STRUCTURES (Initialized as empty, populated by loadAndRender) ---
            let annotationsData = {};
            let annotationsMap = {};


        const transcriptContentEl = document.getElementById('transcript-content');
        const sidebar = document.getElementById('annotation-sidebar');
        const defaultMessage = document.getElementById('default-message');
        const annotationContent = document.getElementById('annotation-content');
        const annotationType = document.getElementById('annotation-type');
        const annotationNote = document.getElementById('annotation-note');
        const closeBtn = document.getElementById('close-btn');

            // --- DATA LOADING & MAPPING ---

            // IMPORTANT: This function now uses the fetch API to load the data from a separate file.
            // The file 'transcript_data.json' MUST be in the same directory as this HTML file.
            async function loadAndRender() {
                const filePath = 'transcript_data.json';

                try {
                    // 1. Fetch the data from the separate JSON file
                    const response = await fetch(filePath);

                    // Check for HTTP errors (e.g., 404 Not Found)
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}. Ensure '${filePath}' is in the same directory.`);
                    }

                    // 2. Parse the JSON response text into the annotationsData object
                    annotationsData = await response.json();

                    // 3. Build the annotationsMap for quick lookup
                    annotationsMap = annotationsData.highlights.reduce((map, item) => {
                        map[item.id] = item;
                        return map;
                    }, {});

                renderTranscript(); // Start rendering now that data is loaded

            } catch (error) {
                console.error("Error loading transcript data from file system:", error);
                transcriptContentEl.innerHTML = `<p class="text-red-600 p-4 bg-red-100 rounded-lg">
                    Error loading data: ${error.message}
                    <br>
                    Please ensure the **'transcript_data.json'** file exists in the same folder as this HTML file.
                </p>`;
            }
        }

        // --- RENDERING LOGIC ---

        function renderTranscript() {
            let html = '';

            annotationsData.transcriptData.forEach(segment => {
                let segmentText = segment.text;
                
                // CRITICAL CHECK: ONLY process highlighting if the current speaker is the Technician.
                if (segment.speaker === "Technician") { 
                    
                    // 1. Find and replace highlighted fragments within this segment's text
                    annotationsData.highlights.forEach(highlight => {
                        // Check to ensure the highlight data itself is intended for the Technician (safety check)
                        if (highlight.speaker === segment.speaker) { 
                            // Create the HTML for the highlight
                            const highlightHtml = `<span class="highlight-span" data-annotation-id="${highlight.id}">${highlight.fragment}</span>`;
                            
                            // Use regex replacement for safety and global replacement within the segment text
                            const regex = new RegExp(escapeRegExp(highlight.fragment), 'g');
                            segmentText = segmentText.replace(regex, highlightHtml);
                        }
                    });
                }

                // 2. Build the full segment HTML
                html += `
                    <div class="transcript-line">
                        <span class="speaker-${segment.speaker}">${segment.speaker}:</span> ${segmentText}
                    </div>
                `;
            });

            transcriptContentEl.innerHTML = html;
            attachHighlightListeners(); // Attach listeners after rendering
        }

        // Helper function to escape special characters in text for RegExp creation
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
        }

        // --- EVENT HANDLERS ---
        
        // Function to display the annotation
        function showAnnotation(id, targetElement) {
            const data = annotationsMap[id];
            if (!data) return;

            // 1. Update content
            annotationType.textContent = `${data.objective} â€” ${data.type}`;
            annotationNote.textContent = data.note;

            // 2. Apply color coding based on type (using the class defined in data)
            annotationType.classList.remove('text-red-600', 'text-green-600', 'text-blue-600', 'text-orange-600');
            annotationType.classList.add(data.colorClass);

            // 3. Toggle visibility
            defaultMessage.classList.add('hidden');
            annotationContent.classList.remove('hidden');
            
            // 4. Activate sidebar visibility on mobile
            sidebar.classList.add('active');

            // 5. Update active highlight styles
            document.querySelectorAll('.highlight-span').forEach(s => s.classList.remove('font-extrabold', 'shadow-md'));
            if (targetElement) {
                targetElement.classList.add('font-extrabold', 'shadow-md');
            }
        }

        // Function to reset the sidebar
        function hideAnnotation() {
             // 1. Toggle visibility
            annotationContent.classList.add('hidden');
            defaultMessage.classList.remove('hidden');
            
            // 2. Deactivate sidebar visibility on mobile
            sidebar.classList.remove('active');
            
            // 3. Remove active highlight styles
            document.querySelectorAll('.highlight-span').forEach(s => s.classList.remove('font-extrabold', 'shadow-md'));
        }

        // Attach event listeners to all dynamically created highlighted spans
        function attachHighlightListeners() {
            document.querySelectorAll('.highlight-span').forEach(span => {
                span.addEventListener('click', (event) => {
                    const annotationId = event.currentTarget.dataset.annotationId;
                    if (annotationId) {
                        showAnnotation(annotationId, event.currentTarget);
                    }
                });
            });
        }

        // Add event listener to the close button (for mobile view)
        closeBtn.addEventListener('click', hideAnnotation);

        // Initial rendering of the transcript
            window.onload = loadAndRender;

    </script>
</body>
</html>
